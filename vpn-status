#!/usr/bin/env python3
import os
import sys
import subprocess
from vpn_utils import (
    read_pid_file,
    is_process_running,
    get_vpn_ip,
    get_process_start_time,
    format_duration,
    get_log_file
)

def print_status(message, level='INFO'):
    level_colors = {
        'INFO': '\033[94m',
        'SUCCESS': '\033[92m',
        'WARNING': '\033[93m',
        'ERROR': '\033[91m',
        'HEADER': '\033[96m',
        'VALUE': '\033[97m'
    }
    color = level_colors.get(level, '')
    reset = '\033[0m'
    print(f"{color}{message}{reset}", flush=True)

def get_recent_logs(log_file, lines=10):
    if not os.path.exists(log_file):
        return []
    
    try:
        result = subprocess.run(
            ['tail', '-n', str(lines), log_file],
            capture_output=True,
            text=True,
            check=True
        )
        return result.stdout.strip().split('\n')
    except subprocess.CalledProcessError:
        return []

def find_openvpn_processes():
    try:
        result = subprocess.run(
            ['pgrep', '-x', 'openvpn'],
            capture_output=True,
            text=True,
            check=False
        )
        if result.returncode == 0:
            return result.stdout.strip().split('\n')
        return []
    except Exception:
        return []

def main():
    print_status("=" * 50, 'HEADER')
    print_status("VPN Status", 'HEADER')
    print_status("=" * 50, 'HEADER')
    print()
    
    pid = read_pid_file()
    
    if not pid:
        print_status("Status: DISCONNECTED", 'WARNING')
        print()
        
        openvpn_pids = find_openvpn_processes()
        if openvpn_pids:
            print_status(f"Warning: Found OpenVPN processes without PID file:", 'WARNING')
            for openvpn_pid in openvpn_pids:
                print_status(f"  - PID: {openvpn_pid}", 'VALUE')
            print()
            print_status("Run ./vpn-disconnect to stop these processes", 'INFO')
        else:
            print_status("No VPN connection found", 'INFO')
        
        return 0
    
    if not is_process_running(pid):
        print_status("Status: DISCONNECTED (stale PID file)", 'WARNING')
        print_status(f"PID: {pid}", 'VALUE')
        print()
        print_status("Run ./vpn-disconnect to clean up", 'INFO')
        return 1
    
    print_status("Status: CONNECTED", 'SUCCESS')
    print()
    
    print_status("Connection Details:", 'HEADER')
    print_status(f"  Process ID: {pid}", 'VALUE')
    
    vpn_ip = get_vpn_ip()
    if vpn_ip:
        print_status(f"  VPN IP: {vpn_ip}", 'VALUE')
    else:
        print_status("  VPN IP: Not available", 'WARNING')
    
    start_time = get_process_start_time(pid)
    if start_time:
        import time
        duration = time.time() - start_time.timestamp()
        print_status(f"  Duration: {format_duration(duration)}", 'VALUE')
        print_status(f"  Connected: {start_time.strftime('%Y-%m-%d %H:%M:%S')}", 'VALUE')
    
    print()
    
    log_file = get_log_file()
    if os.path.exists(log_file):
        print_status("Recent Logs:", 'HEADER')
        recent_logs = get_recent_logs(log_file, 5)
        
        if recent_logs:
            for log in recent_logs:
                if log:
                    if 'Initialization Sequence Completed' in log:
                        print_status(f"  {log}", 'SUCCESS')
                    elif 'AUTH_FAILED' in log or 'ERROR' in log.upper():
                        print_status(f"  {log}", 'ERROR')
                    else:
                        print_status(f"  {log}", 'VALUE')
        else:
            print_status("  No logs available", 'INFO')
        
        print()
        print_status(f"Log file: {log_file}", 'INFO')
    else:
        print_status("No log file found", 'WARNING')
    
    print()
    print_status("=" * 50, 'HEADER')

if __name__ == '__main__':
    try:
        sys.exit(main())
    except KeyboardInterrupt:
        print()
        sys.exit(0)
