#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const os = require('os');
const { execSync } = require('child_process');

const HOME = os.homedir();
const PIDFILE = path.join(HOME, '.vpn.pid');
const AUTHFILE = path.join(HOME, '.vpn.auth');

if (!fs.existsSync(PIDFILE)) {
    console.error('PID file not found. Checking for any running OpenVPN processes...');
    try {
        // specific check for openvpn
        const pids = execSync('pgrep -x openvpn || true', { encoding: 'utf-8' }).trim();
        
        if (!pids) {
            console.error('No OpenVPN processes found running.');
            process.exit(1);
        }

        console.error(`Found OpenVPN process(es) with PID: ${pids.replace(/\n/g, ', ')}`);
        
        const pidList = pids.split('\n');
        let killedAny = false;

        for (const p of pidList) {
            console.error(`Attempting to kill PID ${p}...`);
            try {
                // Try SIGTERM first
                process.kill(p, 'SIGTERM');
                killedAny = true;
            } catch (e) {
                console.error(`Error killing PID ${p}: ${e.message}`);
            }
        }
        
        if (killedAny) {
             // Give it a moment to die
             execSync('sleep 1');
             // Verify
             const remaining = execSync('pgrep -x openvpn || true', { encoding: 'utf-8' }).trim();
             if (remaining) {
                 console.error(`Warning: Some processes might still be running: ${remaining.replace(/\n/g, ', ')}`);
                 console.error('You may need to force kill or use sudo.');
             } else {
                 console.error('All OpenVPN processes terminated.');
             }
        }
        process.exit(0);

    } catch (e) {
        console.error('Error checking processes:', e.message);
        process.exit(1);
    }
}

const pid = fs.readFileSync(PIDFILE, 'utf-8').trim();

// Check if process is running
let isRunning = false;
try {
    process.kill(pid, 0);
    isRunning = true;
} catch (e) {
    // Not running
}

if (!isRunning) {
    console.error('VPN process not running (stale PID file)');
    try { fs.unlinkSync(PIDFILE); } catch(e){}
    try { fs.unlinkSync(AUTHFILE); } catch(e){}
    process.exit(1);
}

console.error(`Disconnecting VPN (PID: ${pid})...`);

// Send SIGTERM
try {
    process.kill(pid, 'SIGTERM');
} catch (e) {
    // Ignore if already gone
}

// Wait loop
const waitForExit = async () => {
    for (let i = 0; i < 20; i++) { // 10 seconds timeout
        try {
            process.kill(pid, 0);
            await new Promise(r => setTimeout(r, 500));
        } catch (e) {
            return true; // Process gone
        }
    }
    return false;
};

// Async main wrapper
(async () => {
    const exited = await waitForExit();

    if (!exited) {
        console.error('Force killing OpenVPN process...');
        try {
            process.kill(pid, 'SIGKILL');
        } catch (e) {
             console.error(`Error force killing PID ${pid}: ${e.message}`);
        }
    }

    // Cleanup
    if (fs.existsSync(PIDFILE)) fs.unlinkSync(PIDFILE);
    if (fs.existsSync(AUTHFILE)) fs.unlinkSync(AUTHFILE);

    console.error('VPN disconnected');
})();