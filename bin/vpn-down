#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const os = require('os');
const { execSync } = require('child_process');

const HOME = os.homedir();
const PIDFILE = path.join(HOME, '.vpn.pid');
const AUTHFILE = path.join(HOME, '.vpn.auth');

if (!fs.existsSync(PIDFILE)) {
    console.error('VPN is not connected (PID file not found)');
    process.exit(1);
}

const pid = fs.readFileSync(PIDFILE, 'utf-8').trim();

// Check if process is running
let isRunning = false;
try {
    process.kill(pid, 0);
    isRunning = true;
} catch (e) {
    // Not running
}

if (!isRunning) {
    console.error('VPN process not running (stale PID file)');
    try { fs.unlinkSync(PIDFILE); } catch(e){}
    try { fs.unlinkSync(AUTHFILE); } catch(e){}
    process.exit(1);
}

console.error(`Disconnecting VPN (PID: ${pid})...`);

// Send SIGTERM
try {
    process.kill(pid, 'SIGTERM');
} catch (e) {
    // Ignore if already gone
}

// Wait loop
const waitForExit = async () => {
    for (let i = 0; i < 20; i++) { // 10 seconds timeout
        try {
            process.kill(pid, 0);
            await new Promise(r => setTimeout(r, 500));
        } catch (e) {
            return true; // Process gone
        }
    }
    return false;
};

// Async main wrapper
(async () => {
    const exited = await waitForExit();

    if (!exited) {
        console.error('Force killing OpenVPN process...');
        try {
            process.kill(pid, 'SIGKILL');
            await new Promise(r => setTimeout(r, 1000));
        } catch (e) {
            // Ignore
        }
    }

    // Cleanup
    if (fs.existsSync(PIDFILE)) fs.unlinkSync(PIDFILE);
    if (fs.existsSync(AUTHFILE)) fs.unlinkSync(AUTHFILE);

    console.error('VPN disconnected');
})();