#!/usr/bin/env python3
import os
import sys
import subprocess
from vpn_utils import get_log_file

def print_colored_line(line):
    if not line:
        return
    
    if 'Initialization Sequence Completed' in line:
        print(f'\033[92m{line}\033[0m')
    elif 'AUTH_FAILED' in line or 'ERROR' in line.upper() or 'FATAL' in line.upper():
        print(f'\033[91m{line}\033[0m')
    elif 'WARNING' in line.upper():
        print(f'\033[93m{line}\033[0m')
    elif 'INFO' in line:
        print(f'\033[94m{line}\033[0m')
    else:
        print(line)

def main():
    import argparse
    
    parser = argparse.ArgumentParser(description='View VPN logs')
    parser.add_argument('-f', '--follow', action='store_true', help='Follow log output (tail -f)')
    parser.add_argument('-n', '--tail', type=int, default=50, help='Number of lines to show (default: 50)')
    parser.add_argument('--level', choices=['INFO', 'WARNING', 'ERROR', 'SUCCESS'], help='Filter by log level')
    
    args = parser.parse_args()
    
    log_file = get_log_file()
    
    if not os.path.exists(log_file):
        print(f"Log file not found: {log_file}", file=sys.stderr)
        sys.exit(1)
    
    print(f"Viewing logs from: {log_file}")
    print("=" * 50)
    
    if args.follow:
        print("Following log output (Ctrl+C to stop)...")
        print("=" * 50)
        
        try:
            process = subprocess.Popen(
                ['tail', '-f', log_file],
                stdout=subprocess.PIPE,
                stderr=subprocess.PIPE,
                text=True,
                bufsize=1
            )
            
            for line in process.stdout:
                if args.level:
                    if args.level in line:
                        print_colored_line(line.rstrip())
                else:
                    print_colored_line(line.rstrip())
            
            process.wait()
        except KeyboardInterrupt:
            print("\nStopped following logs")
            process.terminate()
            process.wait()
    else:
        print(f"Showing last {args.tail} lines...")
        print("=" * 50)
        
        try:
            result = subprocess.run(
                ['tail', '-n', str(args.tail), log_file],
                capture_output=True,
                text=True,
                check=True
            )
            
            lines = result.stdout.strip().split('\n')
            
            for line in lines:
                if args.level:
                    if args.level in line:
                        print_colored_line(line)
                else:
                    print_colored_line(line)
        
        except subprocess.CalledProcessError as e:
            print(f"Error reading log file: {e.stderr}", file=sys.stderr)
            sys.exit(1)

if __name__ == '__main__':
    main()
